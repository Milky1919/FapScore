# FAP アラートボット 技術仕様書

## 1. 文書概要

本文書は、Discordボット「FAP アラートボット（仮称）」の開発に必要な技術仕様を定義する。 開発者は、本文書および別途提供される「FAP Analyzer API 仕様書 (v1)」を参照し、自らの裁量で最適な技術選定と実装を行うこと。

## 2. プロジェクト概要

### 2.1. プロダクト名

FAP アラートボット (FAP Alert Bot)

### 2.2. 目的とコンセプト

**目的:** FF14フレンド募集サイト「FaP」の投稿データを分析する「FAP Analyzer API」と連携し、Discordユーザーが希望する条件の新規投稿通知（アラート）を簡単に作成・管理できるようにすること。

**コンセプト: 「API通知機能への設定仲介役」** 本ボットの**最大の責務は、通知ルールの設定・管理**である。 FAP Analyzer API には、条件に一致した新規投稿を指定のWebhook URLへ通知する機能が既に実装されている。

本ボットは、そのAPI機能をDiscordのスラッシュコマンド経由で利用可能にするためのインターフェースとして機能する。

**責務の範囲:**

*   **ボットが実装すること (責務):**
    
    *   Discordスラッシュコマンドのインターフェース提供。
    *   ユーザーからのコマンド入力を解釈し、「FAP Analyzer API」が要求する形式（JSON）に変換すること。
    *   DiscordチャンネルからWebhook URLを（必要に応じて作成または取得し）管理すること。
    *   APIの `/api/v1/alerts` エンドポイント群 (POST, GET, DELETE) を適切に呼び出すこと。
    *   APIからのレスポンスを解釈し、Discordユーザーに結果をフィードバックすること。
*   **ボットが実装しないこと (責務外):**
    
    *   FAP Analyzer API の定期的なポーリング（監視）。
    *   新規投稿の検知ロジック。
    *   **通知（アラート）メッセージのDiscordへの直接投稿。** (これはAPI側の責務である)

## 3. システムアーキテクチャ

### 3.1. 構成要素

1.  **Discord:** ユーザーインターフェース。スラッシュコマンドの実行環境。
2.  **FAP アラートボット:** DiscordとFAP Analyzer APIを仲介するアプリケーション。
3.  **FAP Analyzer API:** 投稿データの分析と、登録されたルールに基づく通知実行機能を持つバックエンドAPI。

### 3.2. シーケンス (責務の明確化)

#### (A) 通知ルール登録時 (ボットの責務)

1.  `ユーザー` がDiscordで `/fap_alert_add` を実行。
2.  `ボット` がコマンド引数と通知先チャンネルのWebhook URLを取得。
3.  `ボット` が `FAP Analyzer API` の `POST /api/v1/alerts` を呼び出し、ルールを登録。
4.  `ボット` が `ユーザー` に登録完了（または失敗）を通知。

#### (B) 新規投稿通知時 (APIの責務)

1.  `FAP Analyzer API` (バックグラウンド) が新規投稿を検知。
2.  `FAP Analyzer API` が登録済みの通知ルールと照合。
3.  `FAP Analyzer API` が条件に一致したルールの `webhook_url` に対し、**直接** Discordへ通知を送信。

## 4. 技術スタック (推奨)

開発者は、以下の推奨スタック、または同等の機能を実現できる代替スタックを選定する責任を持つ。

*   **実行環境:** Docker
*   **開発言語:** Python 3.10+ または Node.js 18+
*   **主要ライブラリ (推奨):**
    
    *   **Python:** `disnake` (または `discord.py`) + `requests` + `python-dotenv`
    *   **Node.js:** `discord.js` + `axios` (または `node-fetch`) + `dotenv`
*   **非同期処理:** Discord APIとの通信は非同期I/O (async/await) を前提として実装すること。

## 5. 環境変数

ボットの実行コンテナには、以下の環境変数が設定されることを前提とする。

| 変数名               | 説明                                                      |
| ----------------- | ------------------------------------------------------- |
| DISCORD_BOT_TOKEN | Discord Developer Portalで発行されるボットトークン。                  |
| FAP_API_BASE_URL  | 連携するFAP Analyzer APIのベースURL (例: http://localhost:8000)。 |

## 6. 機能要件

ボットは、以下のスラッシュコマンドを提供しなければならない。 各コマンドの引数（オプション）の具体的な選定、バリデーション、およびAPIパラメータへのマッピングは、開発者の裁量に委ねる。

### 6.1. `/fap_alert_add` (通知ルールの登録)

*   **概要:** 新しい通知ルールをAPIに登録する。
*   **必須引数:**
    
    *   `channel` (Channel): 通知を投稿させたいDiscordチャンネル。
*   **任意引数:**
    
    *   `min_score` (Number): 最低ユニークスコア。
    *   `purpose` (String): 募集目的。
    *   ...その他、「FAP Analyzer API 仕様書 4.1.」に記載のクエリパラメータを参考に、ユーザー利便性を考慮して選定すること。
*   **主要ロジック:**
    
    1.  指定された `channel` に対するWebhook URLを取得または作成する。
    2.  コマンド実行サーバーの `guild_id` を取得する。
    3.  任意引数を `conditions_json` (JSON文字列) に整形する。
    4.  `POST /api/v1/alerts` を呼び出す。
    5.  成功時、レスポンスに含まれる `alert_id` をユーザーに返信する。
*   **開発者が解決すべき課題:**
    
    *   Webhookの管理（権限チェック、作成失敗時のハンドリング）。
    *   API仕様書 4.1. の多様なパラメータ（特に配列型）を、Discordコマンドオプションでいかに直感的に入力させるか。
    *   APIからのエラーレスポンス（4xx, 5xx）をユーザーフレンドリーなメッセージに変換する処理。

### 6.2. `/fap_alert_list` (通知ルールの一覧)

*   **概要:** 現在のDiscordサーバーで登録されている通知ルールを一覧表示する。
*   **必須引数:** なし
*   **主要ロジック:**
    
    1.  コマンド実行サーバーの `guild_id` を取得する。
    2.  `GET /api/v1/alerts` (クエリパラメータ `guild_id`) を呼び出す。
    3.  返却されたルールの配列を、`alert_id`, `webhook_url` (可能ならチャンネル名に変換), `conditions_json` が見やすいように整形し、DiscordのEmbed等を用いて返信する。
*   **開発者が解決すべき課題:**
    
    *   Webhook URLからDiscordチャンネル名を特定するロジック（または特定を諦めURLをそのまま表示する判断）。
    *   多数のルールが存在する場合のページネーション（または表示上限）の設計。
    *   `conditions_json` の内容を人間が読みやすい形式に整形するロジック。

### 6.3. `/fap_alert_remove` (通知ルールの削除)

*   **概要:** 指定したIDの通知ルールを削除する。
*   **必須引数:**
    
    *   `alert_id` (Integer): 削除対象のルールID。
*   **主要ロジック:**
    
    1.  `DELETE /api/v1/alerts/{alert_id}` を呼び出す。
    2.  成功時（204 No Content）は、削除完了メッセージを返信する。
*   **開発者が解決すべき課題:**
    
    *   存在しない `alert_id` が指定された場合 (APIから 404 Not Found) のエラーハンドリング。
    *   （任意）コマンド実行者が、対象サーバーの管理権限を持っているかどうかの事前チェック。
    *   （任意）`/fap_alert_list` で取得したIDのみをサジェストするオートコンプリート機能の実装。

## 7. 非機能要件

*   **ロギング:** ボットの起動、コマンドの実行、API通信（成功・失敗）、および予期せぬエラーは、標準出力（stdout/stderr）にログとして記録すること。
*   **エラー耐性:** APIサーバーのダウン時や、Discord APIの障害時にもボットプロセスがクラッシュせず、可能な限りエラーメッセージをユーザーに返信すること。
*   **Dockerfile:** プロジェクトルートに、`docker build` のみで実行可能なイメージをビルドできる `Dockerfile` を含めること。